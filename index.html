<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="参差多态是幸福的本源">
<meta property="og:type" content="website">
<meta property="og:title" content="GeekCat">
<meta property="og:url" content="http://geekcat.me/index.html">
<meta property="og:site_name" content="GeekCat">
<meta property="og:description" content="参差多态是幸福的本源">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="GeekCat">
<meta name="twitter:description" content="参差多态是幸福的本源">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://geekcat.me/"/>





  <title> GeekCat </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">GeekCat</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://geekcat.me/2017/04/09/2017/暴雪哈希去重器/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="geekcat">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/user.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="GeekCat">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="GeekCat" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/09/2017/暴雪哈希去重器/" itemprop="url">
                  暴雪哈希去重器
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-04-09T22:06:51+08:00">
                2017-04-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/04/09/2017/暴雪哈希去重器/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/04/09/2017/暴雪哈希去重器/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="去重器"><a href="#去重器" class="headerlink" title="去重器"></a>去重器</h1><p>在做数据处理的时候，去重是非常常用的一种操作，通过Java语言去做去重，一般直接想到使用HashSet，Java的HashSet内部其实还是一个HashMap，如果看过HashSet的源码，你会发现add一个元素e，其实内部是<code>map.put(e, PRESENT)</code>，PRESENT是一个公用的Object，通过返回值来判断e是否存在在map里，所以HashSet内部存储你可以等价于一个HashMap，只不过所有的Value是一个公用的Object对象。</p>
<p>那我接下来谈谈HashMap的实现，HashMap内部有一个哈希桶数组<code>Entry&lt;K,V&gt;[] table</code>，每来一对K/V，会对K进行哈希，哈希值进行取模对应到table中的一个位置，如果桶里已经存在V，那么就发生了Hash冲突，桶的大小是有限，Hash能把数据打散，但冲突在所难免，这时候每个桶里对应的就不是单纯的V，而是一个链表（Java8中又进行的优化，当链表长度到阈值，会变形成红黑树，取值时的搜索速度）</p>
<h1 id="当你碰到内存的问题"><a href="#当你碰到内存的问题" class="headerlink" title="当你碰到内存的问题"></a>当你碰到内存的问题</h1><p>你已经了解到HashSet、HashMap的内部存储，你会发现你不得不记录所有的K/V，因为你这些容器还要提供给你get的操作，但是当你只需要一个去重功能的时候，你的内存非常珍惜的时候，使用HashSet去去重是不明智的。</p>
<p>如果有一种神奇的Hash算法，对于每一个Key，都能计算出一个绝不冲突的哈希值，那么问题就简单了，我只要记录这个哈希值就好了，需要的存储就小了很多。</p>
<p>有没有银弹呢？我最近发现了一种哈希算法：暴雪哈希</p>
<blockquote>
<p><a href="https://www.biaodianfu.com/blizzard-hash.html" target="_blank" rel="external">https://www.biaodianfu.com/blizzard-hash.html</a><br>暴雪公司的魔兽、星际等游戏都一样一个非常大的MPQ文件，该文件存储了游戏中的大部分数据，想要把这些文字找出来，简单的办法是从数组头开始，一个个字符串读过去，比较每一个，直到找到对应的内容。Blizzard的天才和牛人们当然不会这样做，他们用了更聪明的方法: 用某种算法，把一个字符串压缩成一个整数，即hash。然后，根据这个整数值，直接得到此字符串在整个文件中的位置，从而直接读取之。</p>
</blockquote>
<p>这个Hash算法非常高效具体实现在<a href="http://sfsrealm.hopto.org/inside_mopaq/chapter2.htm，内部计算了三个哈希值，一个当作偏移量，另两个效验。三者同时冲突的概率为1:18889465931478580854784，百亿亿分之一，这个冲突概率在很多数据处理中完全是可以接受的（收集的数据中出现噪声的概率要比这高的多）。" target="_blank" rel="external">http://sfsrealm.hopto.org/inside_mopaq/chapter2.htm，内部计算了三个哈希值，一个当作偏移量，另两个效验。三者同时冲突的概率为1:18889465931478580854784，百亿亿分之一，这个冲突概率在很多数据处理中完全是可以接受的（收集的数据中出现噪声的概率要比这高的多）。</a></p>
<p>下面是我通过暴雪Hash实现的去重器，每个key只记录哈希值，无法还原原值，但是存储要比HashSet小的多。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlizzardHashSet</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_INITIAL_CAPACITY = <span class="number">200</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> size = <span class="number">0</span>;</div><div class="line">    <span class="keyword">private</span> Entry[] table;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> cryptTable[];</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BlizzardHashSet</span><span class="params">()</span> </span>&#123;</div><div class="line">        initTable();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initTable</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> capacity = DEFAULT_INITIAL_CAPACITY;</div><div class="line">        <span class="keyword">this</span>.table = <span class="keyword">new</span> Entry[capacity];</div><div class="line">        initCryptTable();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * return number of keys in hash table</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> number of keys</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> size;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkSize</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="number">2</span> * size &gt; table.length) &#123;</div><div class="line">            <span class="keyword">int</span> newSize = table.length &lt;&lt; <span class="number">1</span>;</div><div class="line">            Entry[] newTable = <span class="keyword">new</span> Entry[newSize];</div><div class="line">            <span class="keyword">for</span> (Entry e : table) &#123;</div><div class="line">                <span class="keyword">while</span> (e != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">int</span> pos = Math.abs(e.getHash() % newSize);</div><div class="line">                    <span class="keyword">if</span> (newTable[pos] == <span class="keyword">null</span>) &#123;</div><div class="line">                        newTable[pos] = e;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">else</span> &#123;</div><div class="line">                        Entry current = newTable[pos];</div><div class="line">                        Entry next = current.next;</div><div class="line">                        <span class="keyword">do</span> &#123;</div><div class="line">                            <span class="keyword">if</span> (next == <span class="keyword">null</span>) &#123;</div><div class="line">                                current.next = e;</div><div class="line">                                <span class="keyword">break</span>;</div><div class="line">                            &#125;</div><div class="line">                            <span class="keyword">else</span> &#123;</div><div class="line">                                current = next;</div><div class="line">                                next = current.next;</div><div class="line">                            &#125;</div><div class="line">                        &#125; <span class="keyword">while</span> (<span class="keyword">true</span>);</div><div class="line">                    &#125;</div><div class="line">                    Entry temp = e.next;</div><div class="line">                    <span class="keyword">if</span> (temp != <span class="keyword">null</span>) &#123;</div><div class="line">                        e.next = <span class="keyword">null</span>;</div><div class="line">                    &#125;</div><div class="line">                    e = temp;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            table = newTable;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(String str)</span> </span>&#123;</div><div class="line">        Entry e = <span class="keyword">new</span> Entry(str);</div><div class="line">        <span class="keyword">int</span> hash = e.getHash();</div><div class="line">        <span class="keyword">int</span> pos = Math.abs(hash % table.length);</div><div class="line">        <span class="keyword">if</span> (table[pos] == <span class="keyword">null</span>) &#123;</div><div class="line">            table[pos] = e;</div><div class="line">            size ++;</div><div class="line">            checkSize();</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            Entry oldEntry = table[pos];</div><div class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (checkHash(oldEntry, e)) &#123;</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (oldEntry.next == <span class="keyword">null</span>) &#123;</div><div class="line">                    oldEntry.next = e;</div><div class="line">                    size ++;</div><div class="line">                    checkSize();</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">                &#125;</div><div class="line">                oldEntry = oldEntry.next;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">checkHash</span><span class="params">(Entry a, Entry b)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> !(a.hash != b.hash || a.hashA != b.hashA || a.hashB != b.hashB);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Tests if this hashtable maps no keys to values.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> hash table is empty or not</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> size == <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initCryptTable</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.cryptTable = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">0x500</span>];</div><div class="line">        <span class="keyword">int</span> seed = <span class="number">0x00100001</span>;</div><div class="line">        <span class="keyword">int</span> index1 = <span class="number">0</span>, index2 = <span class="number">0</span>, i;</div><div class="line">        <span class="keyword">for</span> (index1 = <span class="number">0</span>; index1 &lt; <span class="number">0x100</span>; index1++) &#123;</div><div class="line">            <span class="keyword">for</span> (index2 = index1, i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++, index2 += <span class="number">0x100</span>) &#123;</div><div class="line">                <span class="keyword">int</span> temp1, temp2;</div><div class="line">                seed = (seed * <span class="number">125</span> + <span class="number">3</span>) % <span class="number">0x2AAAAB</span>;</div><div class="line">                temp1 = (seed &amp; <span class="number">0xFFFF</span>) &lt;&lt; <span class="number">0x10</span>;</div><div class="line">                seed = (seed * <span class="number">125</span> + <span class="number">3</span>) % <span class="number">0x2AAAAB</span>;</div><div class="line">                temp2 = (seed &amp; <span class="number">0xFFFF</span>);</div><div class="line">                cryptTable[index2] = (temp1 | temp2);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Uses MPQ hash algorithm to generate a long type variable as hashed value.</div><div class="line">     * This version only accepts String.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> key</div><div class="line">     *            receive a string as key in hash map.</div><div class="line">     * <span class="doctag">@return</span> returns a long type argument as hashed value</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(String key, <span class="keyword">int</span> dwHashType)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> seed1 = <span class="number">0x7FED7FED</span>, seed2 = <span class="number">0xEEEEEEEE</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; key.length(); i++) &#123;</div><div class="line">            <span class="keyword">int</span> ch = key.charAt(i);</div><div class="line">            seed1 = cryptTable[(dwHashType &lt;&lt; <span class="number">8</span>) + ch]</div><div class="line">                    ^ (seed1 + seed2);</div><div class="line">            seed2 = ch + seed1 + seed2 + (seed2 &lt;&lt; <span class="number">5</span>) + <span class="number">3</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> seed1;</div><div class="line">    &#125;</div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Entry</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> hash,hashA,hashB;</div><div class="line">        Entry next;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Creates new entry.</div><div class="line">         */</div><div class="line">        Entry(String string) &#123;</div><div class="line">            hash = hash(string, <span class="number">1</span>);</div><div class="line">            hashA = hash(string, <span class="number">2</span>);</div><div class="line">            hashB = hash(string, <span class="number">3</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getHash</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> hash;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getHashA</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> hashA;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getHashB</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> hashB;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNext</span><span class="params">(Entry e)</span> </span>&#123;</div><div class="line">            next = e;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://geekcat.me/2017/03/12/2017/如何修改Lucene索引，加速对数据的Distinct、Group By操作/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="geekcat">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/user.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="GeekCat">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="GeekCat" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/12/2017/如何修改Lucene索引，加速对数据的Distinct、Group By操作/" itemprop="url">
                  如何修改Lucene索引，加速对数据的Distinct、Group By操作
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-12T10:39:46+08:00">
                2017-03-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/03/12/2017/如何修改Lucene索引，加速对数据的Distinct、Group By操作/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/03/12/2017/如何修改Lucene索引，加速对数据的Distinct、Group By操作/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>番禺山浣熊厂物语：第二回——按段标签太可恶，魔改索引来加速<br>出场人物：老司机——本喵导师</p>
<h1 id="前情提要"><a href="#前情提要" class="headerlink" title="前情提要"></a>前情提要</h1><p>老司机打造的魔改版Spark终于开放给内部产品使用了，速度那是刚刚的，可是老司机毕竟是老司机，是见过大世面的人。</p>
<p>老司机：“呐，小群，我昨晚夜观天象，紫微星微发红光～～”。</p>
<p>小群：“说人话”。</p>
<p>老司机：“（严肃脸）有一个重要的任务要交给你哇，你要听清楚了，我们这个魔改版的Spark底层使用Lucene做存储，每天每个产品的数据导入后都会存储在多台机器上（多个region），每个region按照日期产品分开目录存储索引，目前每个目录的索引只有一个Segment，这是为什么了呢？原因是我们的数据要进行各种SQL统计操作，再呈现到运营人员眼里。具体细节我在多啰嗦几句，where条件对存储在索引里的Term做筛选，使用反向索引就可以找到所有的DocId(一行记录一个Doc，一列对应一个Field)，找到了所有DocId集合再进行Distinct、Group By却有点麻烦。如果对每个DocId都去寻找真实的Field值再去进行去重、分组操作显然是非常没有效率的，因为这些上报数据的Field重复率很高，这里就用到了Lucene的新特性SortedDocValuesField，这个域加入Doc后可以产生排序标签ord，这是一个正向索引，Doc—&gt;Term，拿到这个文档的DocId后你就可以拿到这篇文档每个域真实值的ord，真实值相同，那么ord也必然相同，获取ord要比获取真实值有效率的多，那么就可以使用ord来完成Distinct、和Group By操作了。”</p>
<p>小群：“你还没有说清楚为什么目前只有一个segment呢？”</p>
<p>老司机：“那就要谈谈这个SortedDocValuesField了，这个特性产生的ord并不是全局的，而是分segment的，比如你存储了0,1,2,3,4在segment1中，它们的标签分别是0,1,2,3,4，存储1,2,3,4在segment2中它们的标签却是0,1,2,3，相同的值4在segment1与segment2中的标签却分别是4与3，原来ord的值只是在自己的segment里排序而已。所以目前只使用一个segment，并没有达到最好的效果哇”</p>
<p>小群：“那交给我的任务就是，修改Lucene的源码，完成这个全局ord咯”</p>
<p>老司机：“聪明”</p>
<p>小群：“（鄙视脸）”</p>
<h1 id="Lucene（5-2-2）源码解析"><a href="#Lucene（5-2-2）源码解析" class="headerlink" title="Lucene（5.2.2）源码解析"></a>Lucene（5.2.2）源码解析</h1><h2 id="首先测试用例验证老司机的话"><a href="#首先测试用例验证老司机的话" class="headerlink" title="首先测试用例验证老司机的话"></a>首先测试用例验证老司机的话</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test01</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    Analyzer analyzer = <span class="keyword">new</span> StandardAnalyzer();</div><div class="line">    Directory directory = <span class="keyword">new</span> NIOFSDirectory(Paths.get(<span class="string">"d://lucene_index"</span>));</div><div class="line">    IndexWriterConfig config = <span class="keyword">new</span> IndexWriterConfig(analyzer);</div><div class="line">    config.setMaxBufferedDocs(<span class="number">10</span>);</div><div class="line">    config.setMergePolicy(NoMergePolicy.INSTANCE);</div><div class="line">    config.setUseCompoundFile(<span class="keyword">false</span>);</div><div class="line">    IndexWriter writer = <span class="keyword">new</span> IndexWriter(directory, config);</div><div class="line">    Random random = <span class="keyword">new</span> Random();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</div><div class="line">        <span class="keyword">int</span> v = random.nextInt(<span class="number">5</span>) + <span class="number">16</span>;</div><div class="line">        Document doc = <span class="keyword">new</span> Document();</div><div class="line">        doc.add(<span class="keyword">new</span> StringField(<span class="string">"f1"</span>, <span class="string">"v"</span> + String.valueOf(v), Field.Store.YES));</div><div class="line">        doc.add(<span class="keyword">new</span> SortedDocValuesField(<span class="string">"f1"</span>, <span class="keyword">new</span> BytesRef(<span class="string">"v"</span> + String.valueOf(v))));</div><div class="line">        writer.addDocument(doc);</div><div class="line">    &#125;</div><div class="line">    writer.close();</div><div class="line">&#125;</div><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test02</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    Directory directory = <span class="keyword">new</span> NIOFSDirectory(Paths.get(<span class="string">"d://lucene_index"</span>));</div><div class="line">    IndexReader reader = DirectoryReader.open(directory);</div><div class="line">    IndexSearcher searcher = <span class="keyword">new</span> IndexSearcher(reader);</div><div class="line">    Query q1 = <span class="keyword">new</span> TermQuery(<span class="keyword">new</span> Term(<span class="string">"f1"</span>, <span class="string">"v"</span> + <span class="string">"20"</span>));</div><div class="line">    TopDocs td1 = searcher.search(q1, <span class="number">10</span>);</div><div class="line">    <span class="keyword">for</span> (ScoreDoc docs : td1.scoreDocs) &#123;</div><div class="line">        <span class="keyword">int</span> readerIndex = ReaderUtil.subIndex(docs.doc, searcher.getIndexReader().leaves());</div><div class="line">        LeafReaderContext leafReader = searcher.getIndexReader().leaves().get(readerIndex);</div><div class="line">        SortedDocValues docValues = DocValues.getSorted(leafReader.reader(), <span class="string">"f1"</span>);</div><div class="line">        <span class="keyword">int</span> ord = docValues.getOrd(docs.doc - leafReader.docBase);</div><div class="line">        System.out.println(<span class="string">"valueCount : "</span> + docValues.getValueCount());</div><div class="line">        System.out.println(<span class="string">"ord : "</span> + ord);</div><div class="line">        String value = docValues.lookupOrd(ord).utf8ToString();</div><div class="line">        System.out.println(<span class="string">"value : "</span> + value);</div><div class="line">        System.out.println(<span class="string">"-------------"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">valueCount : 5</div><div class="line">ord : 4</div><div class="line">value : v20</div><div class="line">-------------</div><div class="line">valueCount : 5</div><div class="line">ord : 4</div><div class="line">value : v20</div><div class="line">-------------</div><div class="line">valueCount : 5</div><div class="line">ord : 4</div><div class="line">value : v20</div><div class="line">-------------</div><div class="line">valueCount : 5</div><div class="line">ord : 4</div><div class="line">value : v20</div><div class="line">-------------</div><div class="line">valueCount : 5</div><div class="line">ord : 4</div><div class="line">value : v20</div><div class="line">-------------</div><div class="line">valueCount : 5</div><div class="line">ord : 4</div><div class="line">value : v20</div><div class="line">-------------</div><div class="line">valueCount : 5</div><div class="line">ord : 4</div><div class="line">value : v20</div><div class="line">-------------</div><div class="line">valueCount : 5</div><div class="line">ord : 4</div><div class="line">value : v20</div><div class="line">-------------</div><div class="line">valueCount : 4</div><div class="line">ord : 3</div><div class="line">value : v20</div><div class="line">-------------</div><div class="line">valueCount : 5</div><div class="line">ord : 4</div><div class="line">value : v20</div><div class="line">-------------</div></pre></td></tr></table></figure>
<p>随机生成v16-v20，查询10个segment，ord标签既有4也有3，验证正确。</p>
<h2 id="解析源码"><a href="#解析源码" class="headerlink" title="解析源码"></a>解析源码</h2><p>在默认的索引链DefaultIndexingChain中有一个索引<code>DocValue</code>的方法，它为不同的类型提供不同的写者<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultIndexingChain</span> <span class="keyword">extends</span> <span class="title">DocConsumer</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">indexDocValue</span><span class="params">(PerField fp, DocValuesType dvType, IndexableField field)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="keyword">if</span> (fp.fieldInfo.getDocValuesType() == DocValuesType.NONE) &#123;</div><div class="line">      <span class="comment">// This is the first time we are seeing this field indexed with doc values, so we</span></div><div class="line">      <span class="comment">// now record the DV type so that any future attempt to (illegally) change</span></div><div class="line">      <span class="comment">// the DV type of this field, will throw an IllegalArgExc:</span></div><div class="line">      fieldInfos.globalFieldNumbers.setDocValuesType(fp.fieldInfo.number, fp.fieldInfo.name, dvType);</div><div class="line">    &#125;</div><div class="line">    fp.fieldInfo.setDocValuesType(dvType);</div><div class="line">    <span class="keyword">int</span> docID = docState.docID;</div><div class="line">    <span class="keyword">switch</span>(dvType) &#123;</div><div class="line">      <span class="keyword">case</span> NUMERIC:</div><div class="line">        <span class="keyword">if</span> (fp.docValuesWriter == <span class="keyword">null</span>) &#123;</div><div class="line">          fp.docValuesWriter = <span class="keyword">new</span> NumericDocValuesWriter(fp.fieldInfo, bytesUsed);</div><div class="line">        &#125;</div><div class="line">        ((NumericDocValuesWriter) fp.docValuesWriter).addValue(docID, field.numericValue().longValue());</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> BINARY:</div><div class="line">        <span class="keyword">if</span> (fp.docValuesWriter == <span class="keyword">null</span>) &#123;</div><div class="line">          fp.docValuesWriter = <span class="keyword">new</span> BinaryDocValuesWriter(fp.fieldInfo, bytesUsed);</div><div class="line">        &#125;</div><div class="line">        ((BinaryDocValuesWriter) fp.docValuesWriter).addValue(docID, field.binaryValue());</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> SORTED:</div><div class="line">        <span class="keyword">if</span> (fp.docValuesWriter == <span class="keyword">null</span>) &#123;</div><div class="line">          fp.docValuesWriter = <span class="keyword">new</span> SortedDocValuesWriter(fp.fieldInfo, bytesUsed);</div><div class="line">        &#125;</div><div class="line">        ((SortedDocValuesWriter) fp.docValuesWriter).addValue(docID, field.binaryValue());</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">        </div><div class="line">      <span class="keyword">case</span> SORTED_NUMERIC:</div><div class="line">        <span class="keyword">if</span> (fp.docValuesWriter == <span class="keyword">null</span>) &#123;</div><div class="line">          fp.docValuesWriter = <span class="keyword">new</span> SortedNumericDocValuesWriter(fp.fieldInfo, bytesUsed);</div><div class="line">        &#125;</div><div class="line">        ((SortedNumericDocValuesWriter) fp.docValuesWriter).addValue(docID, field.numericValue().longValue());</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> SORTED_SET:</div><div class="line">        <span class="keyword">if</span> (fp.docValuesWriter == <span class="keyword">null</span>) &#123;</div><div class="line">          fp.docValuesWriter = <span class="keyword">new</span> SortedSetDocValuesWriter(fp.fieldInfo, bytesUsed);</div><div class="line">        &#125;</div><div class="line">        ((SortedSetDocValuesWriter) fp.docValuesWriter).addValue(docID, field.binaryValue());</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">default</span>:</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"unrecognized DocValues.Type: "</span> + dvType);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我没主要来看看SortedDocValuesWriter，其他写者逻辑类似</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SortedDocValuesWriter</span> <span class="keyword">extends</span> <span class="title">DocValuesWriter</span> </span>&#123;</div><div class="line">  <span class="keyword">final</span> BytesRefHash hash;	<span class="comment">//BytesRef的哈希桶，被写入的value都会转化成BytesRef</span></div><div class="line">  <span class="keyword">private</span> PackedLongValues.Builder pending; 	<span class="comment">//用以存储Long值，底层涉及到压缩算法，真正用途后面再讲</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Counter iwBytesUsed;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">long</span> bytesUsed; <span class="comment">// this currently only tracks differences in 'pending'</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> FieldInfo fieldInfo;	<span class="comment">//域信息</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> EMPTY_ORD = -<span class="number">1</span>;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">SortedDocValuesWriter</span><span class="params">(FieldInfo fieldInfo, Counter iwBytesUsed)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.fieldInfo = fieldInfo;</div><div class="line">    <span class="keyword">this</span>.iwBytesUsed = iwBytesUsed;</div><div class="line">    hash = <span class="keyword">new</span> BytesRefHash(</div><div class="line">        <span class="keyword">new</span> ByteBlockPool(</div><div class="line">            <span class="keyword">new</span> ByteBlockPool.DirectTrackingAllocator(iwBytesUsed)),</div><div class="line">            BytesRefHash.DEFAULT_CAPACITY,</div><div class="line">            <span class="keyword">new</span> DirectBytesStartArray(BytesRefHash.DEFAULT_CAPACITY, iwBytesUsed));</div><div class="line">    pending = PackedLongValues.deltaPackedBuilder(PackedInts.COMPACT);</div><div class="line">    bytesUsed = pending.ramBytesUsed();</div><div class="line">    iwBytesUsed.addAndGet(bytesUsed);</div><div class="line">  &#125;</div><div class="line">  .....</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在<code>DefaultIndexingChain</code>中通过调用<code>((SortedSetDocValuesWriter) fp.docValuesWriter).addValue(docID, field.binaryValue())</code>向写者加入文档id以及域对应的值，在<code>addValue</code>方法中主要进行一些值的check，入后调用了<code>addOneValue</code>，主要逻辑便在里面。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addOneValue</span><span class="params">(BytesRef value)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> termID = hash.add(value);	<span class="comment">//把值加入哈希桶便会返回这个值的termID</span></div><div class="line">    <span class="keyword">if</span> (termID &lt; <span class="number">0</span>) &#123;	<span class="comment">//如果哈希桶中已经有这个值便返回-（counter+1），这里正好把它恢复，并不增加iwBytesUsed</span></div><div class="line">      termID = -termID-<span class="number">1</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;	<span class="comment">//新值增加iwBytesUsed的使用</span></div><div class="line">      <span class="comment">// reserve additional space for each unique value:</span></div><div class="line">      <span class="comment">// 1. when indexing, when hash is 50% full, rehash() suddenly needs 2*size ints.</span></div><div class="line">      <span class="comment">//    <span class="doctag">TODO:</span> can this same OOM happen in THPF?</span></div><div class="line">      <span class="comment">// 2. when flushing, we need 1 int per value (slot in the ordMap).</span></div><div class="line">      iwBytesUsed.addAndGet(<span class="number">2</span> * RamUsageEstimator.NUM_BYTES_INT);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    pending.add(termID);	<span class="comment">//添加termID到pending中</span></div><div class="line">    updateBytesUsed();</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>随着field的加入，达到这个segment的maxDoc时，进行刷新，将内存中的信息写入到磁盘里，对应与flush方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">flush</span><span class="params">(SegmentWriteState state, DocValuesConsumer dvConsumer)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">  <span class="keyword">final</span> <span class="keyword">int</span> maxDoc = state.segmentInfo.maxDoc();	<span class="comment">//段的最大文档数</span></div><div class="line">  <span class="keyword">assert</span> pending.size() == maxDoc;</div><div class="line">  <span class="keyword">final</span> <span class="keyword">int</span> valueCount = hash.size();	<span class="comment">//哈希桶内放置的不同的值的数量</span></div><div class="line">  <span class="keyword">final</span> PackedLongValues ords = pending.build();	<span class="comment">//返回ords，其实就是termID进入addValue的顺序</span></div><div class="line">  <span class="comment">//哈希桶对内部的值进行排序，如果感兴趣可以看看内部的排序算法：内省排序（Introsort），返回的sortedValues是按照termID数组，排序依据是termID的值</span></div><div class="line">  <span class="keyword">final</span> <span class="keyword">int</span>[] sortedValues = hash.sort(BytesRef.getUTF8SortedAsUnicodeComparator());	</div><div class="line">  <span class="keyword">final</span> <span class="keyword">int</span>[] ordMap = <span class="keyword">new</span> <span class="keyword">int</span>[valueCount];</div><div class="line">  <span class="comment">//通过下面的循环，ordMap获得termID具体排第几的排序map</span></div><div class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> ord=<span class="number">0</span>;ord&lt;valueCount;ord++) &#123;</div><div class="line">    ordMap[sortedValues[ord]] = ord;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">//将两个迭代器交给真正的写者，这两个迭代器便是完成ord标签的关键</span></div><div class="line">  dvConsumer.addSortedField(fieldInfo,</div><div class="line">                            <span class="comment">// ord -&gt; value</span></div><div class="line">                            <span class="keyword">new</span> Iterable&lt;BytesRef&gt;() &#123;</div><div class="line">                              <span class="meta">@Override</span></div><div class="line">                              <span class="function"><span class="keyword">public</span> Iterator&lt;BytesRef&gt; <span class="title">iterator</span><span class="params">()</span> </span>&#123;</div><div class="line">                                <span class="keyword">return</span> <span class="keyword">new</span> ValuesIterator(sortedValues, valueCount, hash);</div><div class="line">                              &#125;</div><div class="line">                            &#125;,</div><div class="line">                            <span class="comment">// doc -&gt; ord</span></div><div class="line">                            <span class="keyword">new</span> Iterable&lt;Number&gt;() &#123;</div><div class="line">                              <span class="meta">@Override</span></div><div class="line">                              <span class="function"><span class="keyword">public</span> Iterator&lt;Number&gt; <span class="title">iterator</span><span class="params">()</span> </span>&#123;</div><div class="line">                                <span class="keyword">return</span> <span class="keyword">new</span> OrdsIterator(ordMap, maxDoc, ords);</div><div class="line">                              &#125;</div><div class="line">                            &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>调用<code>ValuesIterator</code>迭代器<code>next</code>方法将依次返回由低到高的<code>BytesRef</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ValuesIterator</span> <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">BytesRef</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> sortedValues[];</div><div class="line">    <span class="keyword">final</span> BytesRefHash hash;</div><div class="line">    <span class="keyword">final</span> BytesRef scratch = <span class="keyword">new</span> BytesRef();</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> valueCount;</div><div class="line">    <span class="keyword">int</span> ordUpto;</div><div class="line">    </div><div class="line">    ValuesIterator(<span class="keyword">int</span> sortedValues[], <span class="keyword">int</span> valueCount, BytesRefHash hash) &#123;</div><div class="line">      <span class="keyword">this</span>.sortedValues = sortedValues;</div><div class="line">      <span class="keyword">this</span>.valueCount = valueCount;</div><div class="line">      <span class="keyword">this</span>.hash = hash;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> ordUpto &lt; valueCount;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> BytesRef <span class="title">next</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">if</span> (!hasNext()) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException();</div><div class="line">      &#125;</div><div class="line">      hash.get(sortedValues[ordUpto], scratch);	<span class="comment">//从哈希桶中取出BytesRef</span></div><div class="line">      ordUpto++;</div><div class="line">      <span class="keyword">return</span> scratch;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>OrdsIterator</code>迭代器，将返回依次加入的termID对应的ord</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">OrdsIterator</span> <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">Number</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">final</span> PackedLongValues.Iterator iter;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> ordMap[];</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> maxDoc;</div><div class="line">    <span class="keyword">int</span> docUpto;</div><div class="line">    </div><div class="line">    OrdsIterator(<span class="keyword">int</span> ordMap[], <span class="keyword">int</span> maxDoc, PackedLongValues ords) &#123;</div><div class="line">      <span class="keyword">this</span>.ordMap = ordMap;</div><div class="line">      <span class="keyword">this</span>.maxDoc = maxDoc;</div><div class="line">      <span class="keyword">assert</span> ords.size() == maxDoc;</div><div class="line">      <span class="keyword">this</span>.iter = ords.iterator();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> docUpto &lt; maxDoc;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Number <span class="title">next</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">if</span> (!hasNext()) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException();</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">int</span> ord = (<span class="keyword">int</span>) iter.next();</div><div class="line">      docUpto++;</div><div class="line">      <span class="keyword">return</span> ord == -<span class="number">1</span> ? ord : ordMap[ord];</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由源码可见，ord只参考加入此segement的term值，如果需要修改为全局的标签，而忽略排序因素的话，我们需要构造一个单例，这个对象为每个域维护一个map，当有term加入这个addOneValue函数，我们先询问map有没有这个key，如果有就返回value(表示key出现的先后顺序)，没有就加入到map，将最大的value加一当作它的value。在进行flush时通过这个全局对象来生成那两个迭代器，由此便可以得到一个Doc–&gt;Term的正向全局标签索引（标签值只对应与Term值的出现顺序，排序呢能力丢失），但是这个却可以是用单个目录进行多段存储（segment），同时提供标签来进行Distinct与Group By。</p>
<p>以上。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://geekcat.me/2017/02/26/2017/番禺山浣熊厂物语：第一回，小群抢话题吹牛皮，老司机度陈仓教做人/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="geekcat">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/user.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="GeekCat">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="GeekCat" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/26/2017/番禺山浣熊厂物语：第一回，小群抢话题吹牛皮，老司机度陈仓教做人/" itemprop="url">
                  番禺山浣熊厂物语：第一回，小群抢话题吹牛皮，老司机度陈仓教做人
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-02-26T22:23:42+08:00">
                2017-02-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/02/26/2017/番禺山浣熊厂物语：第一回，小群抢话题吹牛皮，老司机度陈仓教做人/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/02/26/2017/番禺山浣熊厂物语：第一回，小群抢话题吹牛皮，老司机度陈仓教做人/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>浣熊厂的19点依然是满满的工作氛围，今个也不例外，厂主带领大家围观新系统，左一言又一语，好不快活。小群我自然是要凑这个热闹的。</p>
<p>小群：“这个特性我本来是要装mermaid插件的哇，什么甘特图、流程图、ER图的是小case，但是这个插件的依赖包里需要C++11特性哇，所以哇，现在不行哇…（眉飞色舞，故弄玄虚状）。”</p>
<p>老司机：“哎呀小群不得了哇，看NodeJS了啊，听说这个开发WEB效果很好哇，老人家不懂啊，为什么呢？”</p>
<p>小群：“（这波牛皮我等了7天零15个小时）因为异步、AIO啊，线程在进行IO的时候可以做别的事情啊，所以快啊（内心戏：老司机你也有今天）。”</p>
<p>老司机：“AIO，我怀疑你看了假书啊，小群没事多看看正版资料，window和Linux上都没有实现真正的异步IO。”</p>
<p>小群：“这怎么可能，NodeJS的卖点就是异步呀（难道这回又被光速打脸！！！）”</p>
<p>老司机：“操作系统内核对于I/O只有两种：阻塞与非阻塞。”</p>
<p>小群：“那异步与同步呢？”</p>
<p>老司机：“别插嘴哇，听我慢慢说，阻塞IO造成CPU等待IO，浪费时间，非阻塞IO到用后立刻返回，CPU时间片可以处理其他事情，但是什么时候获取真正的返回呢？”</p>
<p>小群：“要轮询吧，按我的理解换成异步就可以直接获得。”</p>
<p>老司机：“那你先听听这几样非阻塞技术吧，read:最原始的轮询，反复调用来检查IO状态。select:通过对文件描述符上的状态进行判断，有个限制就是它采用1024长度的数组来记录文件描述符（所以一次做多轮询1024个IO是不是已经快了很多），poll:采用链表代替了数组，没了长度限制，但是在文件描述符多的情况下还是没啥性能。epoll:该方案是Linux下最有效率的IO通知机制了，进入轮询但是没有检测到IO事件，将休眠，直到事件发生把它唤醒。”</p>
<p>小群：“epoll已经是最有效率的啦？说好的异步呢？”</p>
<p>老司机：“Linux上说来是有一种AIO但是仅支持内核IO中的O_DIRECT方式读取，无法利用缓存，所以很鸡助哇。”</p>
<p>小群：“那NodeJS是怎么个异步法呢？”</p>
<p>老司机：“线程池模拟异步哇，v0.93这个版本之前都是利用libeio这个库，之后的版本自行实现了线程池模拟异步IO库，window下是利用了IOCP来实现。”</p>
<p>小群：“。。。原来你都懂。。。”</p>
<p>老司机：“发车发车了，下班下班哇。”</p>
<p>留下老司机给的学习资料，深藏功与名。</p>
<p><a href="http://stackoverflow.com/questions/87892/what-is-the-status-of-posix-asynchronous-i-o-aio" target="_blank" rel="external">http://stackoverflow.com/questions/87892/what-is-the-status-of-posix-asynchronous-i-o-aio</a></p>
<p><a href="http://blog.libtorrent.org/2012/10/asynchronous-disk-io/" target="_blank" rel="external">http://blog.libtorrent.org/2012/10/asynchronous-disk-io/</a></p>
<p><a href="https://cnodejs.org/topic/4f16442ccae1f4aa270010a7" target="_blank" rel="external">https://cnodejs.org/topic/4f16442ccae1f4aa270010a7</a></p>
<p><a href="http://stackoverflow.com/questions/8768083/difference-between-posix-aio-and-libaio-on-linux" target="_blank" rel="external">http://stackoverflow.com/questions/8768083/difference-between-posix-aio-and-libaio-on-linux</a></p>
<p><a href="http://www.wzxue.com/linux-kernel-aio%E8%BF%99%E4%B8%AA%E5%A5%87%E8%91%A9/" target="_blank" rel="external">http://www.wzxue.com/linux-kernel-aio%E8%BF%99%E4%B8%AA%E5%A5%87%E8%91%A9/</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://geekcat.me/2017/01/29/2017/用code打造自己的过渡动画/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="geekcat">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/user.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="GeekCat">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="GeekCat" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/29/2017/用code打造自己的过渡动画/" itemprop="url">
                  用code打造自己的过渡动画
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-29T15:50:40+08:00">
                2017-01-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/01/29/2017/用code打造自己的过渡动画/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/01/29/2017/用code打造自己的过渡动画/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="起源"><a href="#起源" class="headerlink" title="起源"></a>起源</h1><p>自己的过渡动画，为什么要这个东西呢？不是说好的Simple is beautiful么。的确我也是非常欣赏简洁的东西，但是对于挂载在Github上的本博客，在国内访问总是不那么流畅，而Next主题的文字下落动画恰恰使博客访问体验变的非常糟糕（感觉访问变得更慢了）。所以本喵决定打造自己的过渡动画。</p>
<h1 id="借鉴"><a href="#借鉴" class="headerlink" title="借鉴"></a>借鉴</h1><p>在两三个月前记得访问过一个个人博客，过渡动画非常惊艳，但当时并没有时间详细琢磨实现细节。如今正好借鉴一番，经过一番Google，还是本喵找到了（但是作者的博客好像没有维护了，无法访问），好在也是依托Github pages 挂载的博客，直接把源码下载下来进行研究。</p>
<p>地址： <a href="https://github.com/ceoimon/ceoimon.github.io" target="_blank" rel="external">https://github.com/ceoimon/ceoimon.github.io</a></p>
<img src="/images/ceoimon.gif">
<p>实现细节</p>
<p>动画并非纯css实现而是使用了SVG + CSS</p>
<blockquote>
<p>可缩放矢量图形（英语：Scalable Vector Graphics，SVG）是一种基于可扩展标记语言（XML），用于描述二维矢量图形的图形格式。 SVG由W3C制定，是一个开放标准。<br>既然是矢量图，它的缩放就不会失真，因为表示方法是基于数学的表示，而不是像素点。动画中的笔画即是基于SVG中path标签中的数据先后顺序。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">#mySVG path &#123;</div><div class="line">  stroke: #000;</div><div class="line">  stroke-width: 2px;</div><div class="line">  stroke-dasharray: 11434;</div><div class="line">  stroke-dashoffset: 11456;</div><div class="line">  -webkit-animation: dash 5s linear infinite;</div><div class="line">  animation: dash 5s linear infinite;</div><div class="line">  -webkit-animation-fill-mode: both;</div><div class="line">          animation-fill-mode: both;</div><div class="line">/*   -webkit-transition:fill 0.5s 1s linear;</div><div class="line">  transition:fill 0.5s 1s linear;*/</div><div class="line">&#125;</div><div class="line">@-webkit-keyframes dash &#123;</div><div class="line">  10% &#123;</div><div class="line">    stroke-dashoffset: 11456;</div><div class="line">  &#125;</div><div class="line">  70% &#123;</div><div class="line">    stroke-dashoffset: 0;</div><div class="line">    fill: transparent;</div><div class="line">  &#125;</div><div class="line">  80% &#123;</div><div class="line">    stroke-dashoffset: 0;</div><div class="line">    fill: #000;</div><div class="line">  &#125;</div><div class="line">  95% &#123;</div><div class="line">    stroke-dashoffset: 11456;</div><div class="line">    fill: #000;</div><div class="line">  &#125;</div><div class="line">  100% &#123;</div><div class="line">    stroke-dashoffset: 11456;</div><div class="line">    fill: transparent;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>不过当我理解了这svg两个属性<code>(stroke-dasharray，stroke-dashoffset)</code>后，还是非常震惊于这个动画的实现原理。</p>
<blockquote>
<p><code>stroke-dasharray</code>属性可控制用来描边的点划线的图案范式。</p>
</blockquote>
<p>MDN给出的示例：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">width</span>=<span class="string">"200"</span> <span class="attr">height</span>=<span class="string">"200"</span> <span class="attr">viewPort</span>=<span class="string">"0 0 200 300"</span> <span class="attr">version</span>=<span class="string">"1.1"</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/2000/svg"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">line</span> <span class="attr">stroke-dasharray</span>=<span class="string">"5, 5"</span>              <span class="attr">x1</span>=<span class="string">"10"</span> <span class="attr">y1</span>=<span class="string">"10"</span> <span class="attr">x2</span>=<span class="string">"190"</span> <span class="attr">y2</span>=<span class="string">"10"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">line</span> <span class="attr">stroke-dasharray</span>=<span class="string">"5, 10"</span>             <span class="attr">x1</span>=<span class="string">"10"</span> <span class="attr">y1</span>=<span class="string">"30"</span> <span class="attr">x2</span>=<span class="string">"190"</span> <span class="attr">y2</span>=<span class="string">"30"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">line</span> <span class="attr">stroke-dasharray</span>=<span class="string">"10, 5"</span>             <span class="attr">x1</span>=<span class="string">"10"</span> <span class="attr">y1</span>=<span class="string">"50"</span> <span class="attr">x2</span>=<span class="string">"190"</span> <span class="attr">y2</span>=<span class="string">"50"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">line</span> <span class="attr">stroke-dasharray</span>=<span class="string">"5, 1"</span>              <span class="attr">x1</span>=<span class="string">"10"</span> <span class="attr">y1</span>=<span class="string">"70"</span> <span class="attr">x2</span>=<span class="string">"190"</span> <span class="attr">y2</span>=<span class="string">"70"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">line</span> <span class="attr">stroke-dasharray</span>=<span class="string">"1, 5"</span>              <span class="attr">x1</span>=<span class="string">"10"</span> <span class="attr">y1</span>=<span class="string">"90"</span> <span class="attr">x2</span>=<span class="string">"190"</span> <span class="attr">y2</span>=<span class="string">"90"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">line</span> <span class="attr">stroke-dasharray</span>=<span class="string">"0.9"</span>               <span class="attr">x1</span>=<span class="string">"10"</span> <span class="attr">y1</span>=<span class="string">"110"</span> <span class="attr">x2</span>=<span class="string">"190"</span> <span class="attr">y2</span>=<span class="string">"110"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">line</span> <span class="attr">stroke-dasharray</span>=<span class="string">"15, 10, 5"</span>         <span class="attr">x1</span>=<span class="string">"10"</span> <span class="attr">y1</span>=<span class="string">"130"</span> <span class="attr">x2</span>=<span class="string">"190"</span> <span class="attr">y2</span>=<span class="string">"130"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">line</span> <span class="attr">stroke-dasharray</span>=<span class="string">"15, 10, 5, 10"</span>     <span class="attr">x1</span>=<span class="string">"10"</span> <span class="attr">y1</span>=<span class="string">"150"</span> <span class="attr">x2</span>=<span class="string">"190"</span> <span class="attr">y2</span>=<span class="string">"150"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">line</span> <span class="attr">stroke-dasharray</span>=<span class="string">"15, 10, 5, 10, 15"</span> <span class="attr">x1</span>=<span class="string">"10"</span> <span class="attr">y1</span>=<span class="string">"170"</span> <span class="attr">x2</span>=<span class="string">"190"</span> <span class="attr">y2</span>=<span class="string">"170"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">line</span> <span class="attr">stroke-dasharray</span>=<span class="string">"5, 5, 1, 5"</span>        <span class="attr">x1</span>=<span class="string">"10"</span> <span class="attr">y1</span>=<span class="string">"190"</span> <span class="attr">x2</span>=<span class="string">"190"</span> <span class="attr">y2</span>=<span class="string">"190"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="xml">&lt;![CDATA[</span></div><div class="line">line&#123;</div><div class="line">    stroke: black;</div><div class="line">    stroke-width: 2;</div><div class="line">&#125;</div><div class="line">]]&gt;<span class="tag">&lt;/<span class="name">style</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></div></pre></td></tr></table></figure>
<svg width="200" height="200" viewbox="0 0 200 200" version="1.1" xmlns="http://www.w3.org/2000/svg"><line stroke-dasharray="5, 5" x1="10" y1="10" x2="190" y2="10"/><line stroke-dasharray="5, 10" x1="10" y1="30" x2="190" y2="30"/><line stroke-dasharray="10, 5" x1="10" y1="50" x2="190" y2="50"/><line stroke-dasharray="5, 1" x1="10" y1="70" x2="190" y2="70"/><line stroke-dasharray="1, 5" x1="10" y1="90" x2="190" y2="90"/><line stroke-dasharray="0.9" x1="10" y1="110" x2="190" y2="110"/><line stroke-dasharray="15, 10, 5" x1="10" y1="130" x2="190" y2="130"/><line stroke-dasharray="15, 10, 5, 10" x1="10" y1="150" x2="190" y2="150"/><line stroke-dasharray="15, 10, 5, 10, 15" x1="10" y1="170" x2="190" y2="170"/><line stroke-dasharray="5, 5, 1, 5" x1="10" y1="190" x2="190" y2="190"/><style>line{stroke:black;stroke-width: 2;}</style></svg>

<blockquote>
<p>stroke-dashoffset属性指定了dash模式到路径开始的距离</p>
</blockquote>
<p>通过CSS修改这两个属性，动画的边界就相应的动起来了。</p>
<h1 id="我的实现"><a href="#我的实现" class="headerlink" title="我的实现"></a>我的实现</h1><p>我的素材：</p>
<img src="/images/impossible_triangle.jpg">
<p>使用 AI 得到 SVG，最终效果：</p>
<img src="/images/impossible_triangle.gif">
<p><a href="httP://geekcat.me">GeekCat体验</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://geekcat.me/2017/01/15/2017/构造自定义领域语言（二）/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="geekcat">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/user.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="GeekCat">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="GeekCat" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/15/2017/构造自定义领域语言（二）/" itemprop="url">
                  构造自定义领域语言（二）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-15T11:14:08+08:00">
                2017-01-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/01/15/2017/构造自定义领域语言（二）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/01/15/2017/构造自定义领域语言（二）/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>上星期比较忙哇，鸽了，这个星期开始补，进展缓慢那补什么呢，翻译一篇官方的词法规则文档吧。待我理解完了AST和翻译器部分开始撸代码┑(￣。。￣)┍</p>
<h1 id="词法规则（Lexer-Rules）"><a href="#词法规则（Lexer-Rules）" class="headerlink" title="词法规则（Lexer Rules）"></a>词法规则（Lexer Rules）</h1><p>词法的语法由词法规则组成，从而分成不同的模式。词法模式允许我们将单个词法语法分成多个子规则。词法分析器只能从当前模式中返回匹配的tokens。</p>
<p>词法规则的的定义或多或少遵循了解析器的语法，但是词法规则不能有参数、返回值和局部变量。词法规则名称必须以大写字母开头，用以区别语法解析器的规则名称：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/** Optional document comment */</div><div class="line">TokenName : alternative1 | ... | alternativeN ;</div></pre></td></tr></table></figure></p>
<p>你也可以定义不是词法tokens的规则，而是帮助识别tokens片段的规则，这些规则对于语法解析器是不可见的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">fragment</div><div class="line">HelperTokenRule : alternative1 | ... | alternativeN ;</div></pre></td></tr></table></figure>
<p>例如，<code>DIGIT</code> 是一个很常见的规则：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">INT : DIGIT+ ; // references the DIGIT helper rule</div><div class="line">fragment DIGIT : [0-9] ; // not a token by itself</div></pre></td></tr></table></figure>
<h1 id="词法模式（Lexical-Modes）"><a href="#词法模式（Lexical-Modes）" class="headerlink" title="词法模式（Lexical Modes）"></a>词法模式（Lexical Modes）</h1><p>词法模式允许你通过上下文对词法规则进行分组。他就像有多个子运算，但是对于特定上线文只有那么一些。词法分析器只能通过当前模式中的规则进行匹配返回tokens。词法分析器开始是默认模式的，除非指定模式，否则所有规则都是属于默认规则的。在组合的语法中是不能使用词法模式的，只有单词的词法语法定义中可以<a href="https://pragprog.com/book/tpantlr2/the-definitive-antlr-4-reference" target="_blank" rel="external">（请参阅XMLLExer）</a>。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">rules in default mode</div><div class="line">...</div><div class="line">mode MODE1;</div><div class="line">rules in MODE1</div><div class="line">...</div><div class="line">mode MODEN;</div><div class="line">rules in MODEN</div><div class="line">...</div></pre></td></tr></table></figure></p>
<h1 id="词法规则元素（Lexer-Rule-Elements）"><a href="#词法规则元素（Lexer-Rule-Elements）" class="headerlink" title="词法规则元素（Lexer Rule Elements）"></a>词法规则元素（Lexer Rule Elements）</h1><p>词法规则允许两种构造方法他们是在语法规则中不可用的：<code>..</code>范围云算法和使用<code>[]</code>扩起字符集。不要将字符集的规则与词法规则混淆。<code>[characters]</code>仅表示<code>characters</code>在词法规则的字符几中，这里是所有词法规则元素的简介：</p>
<table>
<thead>
<tr>
<th style="text-align:left">词法</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">T</td>
<td style="text-align:left">在当前位置允许匹配T，匹配规则名称必须以大写字母开头。</td>
</tr>
<tr>
<td style="text-align:left">’literal’</td>
<td style="text-align:left">匹配字符或者字符串文字，例如， ’while’ or ’=’.</td>
</tr>
<tr>
<td style="text-align:left">[char set]</td>
<td style="text-align:left">匹配字符集中的一个字符，将x-y解释为范围x和y之间的字符集，包括自身。以下转义字符被解释为单个特殊字符：\n, \r, \b, \t, and \f。匹配 ]、\或者 - 你必须使用转移符 \。您也可以使用Unicode字符规范：\uXXXX。这里是一些例子：<br><code>WS : [ \n\u000D] -&gt; skip ; // same as [ \n\r] <br>ID : [a-zA-Z] [a-zA-Z0-9]* ; // match usual identifier spec <br>DASHBRACK : [-]]+ ; // match - or ] one or more times</code></td>
</tr>
<tr>
<td style="text-align:left">’x’..’y’</td>
<td style="text-align:left">匹配范围x和y之间的任意单个字符。例如，’a’..’z’。 ‘a’..’z’与[a-z]相同。</td>
</tr>
<tr>
<td style="text-align:left">T</td>
<td style="text-align:left">调用语法规则T;一般允许递归，但是左递归是禁止的，T可以是常规tokens或者片段规则（fragment rule）：<br><code>ID : LETTER (LETTER&#124;’0’..’9’)* ; fragment LETTER : [a-zA-Z\u0080-\u00FF_] ;</code></td>
</tr>
<tr>
<td style="text-align:left">.</td>
<td style="text-align:left">点是与任何单个字符匹配的单字符通配符，例如：<br><code>ESC : ‘\‘ . ; // match any escaped \x character</code></td>
</tr>
<tr>
<td style="text-align:left">{«action»}</td>
<td style="text-align:left">Lexer操作可以出现在4.2之外的任何位置，而不仅仅出现在最外面用来替代末尾。 词法分析器根据规则中动作的位置来执行动作。 要为具有多个选项执行单个操作，可以将括号括在括号中，然后再执行操作：<br><code>END : (‘endif’&#124;’end’) {System.out.println(“found an end”);} ;</code><br>该操作要符合目标语言的语法。 ANTLR将动作的内容逐字复制到生成的代码中;并没有像$ x.y这样的表达式的翻译，因为着是在动作规则中。只有最外层tokens规则中的action被执行。换句话说，如果STRING调用ESC_CHAR和ESC_CHAR有一个动作，当词法分析器在STRING开始匹配时，不执行该动作。</td>
</tr>
<tr>
<td style="text-align:left">{«p»}?</td>
<td style="text-align:left">评价语义谓词«p»。 如果“p”在运行时评估为false，则周围规则变为“不可见”（不可见）。 表达式«p»符合目标语言语法。 虽然语义谓词可以出现在词法规则中的任何地方，但在规则末尾使用它们是最有效的。 一个警告是，语义谓词必须先于词法分析器动作。 请参阅Lexer规则中的谓词。</td>
</tr>
<tr>
<td style="text-align:left">~x</td>
<td style="text-align:left">匹配不在x中描述的集合中的任何单个字符。Set x可以是单个字符、范围或～<code>（’x’&#124;’y’&#124;’z’）</code>或<code>～[xyz]</code>的子字符集表示。这里有一个规则使用～来匹配任意字符，使用～[\ r \ n] ：<br><code>COMMENT : ‘#’ ~[\r\n] ‘\r’? ‘\n’ -&gt; skip ;<code></code></code></td>
</tr>
</tbody>
</table>
<p>相对于语法规则，词法规则允许子句在括号和EBNF运算符中：?,<em>,+。COMMENT规则说明了</em>,?的使用规则。使用+对于[0-9]+可以去匹配数字，词法子句也可以使用?作为后缀再EBNF操作中。</p>
<h1 id="递归的词法规则（Recursive-Lexer-Rules）"><a href="#递归的词法规则（Recursive-Lexer-Rules）" class="headerlink" title="递归的词法规则（Recursive Lexer Rules）"></a>递归的词法规则（Recursive Lexer Rules）</h1><p>ANTLR词法规则可以是递归的，不同于大多数词法语法工具。当你想匹配嵌套的tokens，如嵌套的动作块，这是很方便的：{…{…}…}。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">lexer grammar Recur;</div><div class="line">ACTION : &apos;&#123;&apos; ( ACTION | ~[&#123;&#125;] )* &apos;&#125;&apos; ;</div><div class="line">WS : [ \r\t\n]+ -&gt; skip ;</div></pre></td></tr></table></figure>
<h1 id="冗余字符串字面量（Redundant-String-Literals）"><a href="#冗余字符串字面量（Redundant-String-Literals）" class="headerlink" title="冗余字符串字面量（Redundant String Literals）"></a>冗余字符串字面量（Redundant String Literals）</h1><p>请注意，不要在多个词法分析器规则的右侧指定相同的字符串文字。这样的文字是模糊的，会导致可以匹配多种token类型。ANTLR 会导致语法解析时匹配这类模糊的文字时不可用。对于跨模式的规则也是如此。例如，以下词法语法定义具有相同字符序列的两个标记：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">lexer grammar L;</div><div class="line">AND : &apos;&amp;&apos; ;</div><div class="line">mode STR;</div><div class="line">MASK : &apos;&amp;&apos; ;</div></pre></td></tr></table></figure>
<p>解析器语法规则不能引用文字“＆”，但它可以引用标记的名称：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">parser grammar P;</div><div class="line">options &#123; tokenVocab=L; &#125;</div><div class="line">a : &apos;&amp;&apos; // results in a tool error: no such token</div><div class="line">    AND // no problem</div><div class="line">    MASK // no problem</div><div class="line"> ;</div></pre></td></tr></table></figure>
<p>这里构建了一个测试序列：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ antlr4 L.g4 # yields L.tokens file needed by tokenVocab option in P.g4</div><div class="line">$ antlr4 P.g4</div><div class="line">error(126): P.g4:3:4: cannot create implicit token for string literal &apos;&amp;&apos; in non-combined grammar</div></pre></td></tr></table></figure>
<h1 id="词法规则的动作（Lexer-Rule-Actions）"><a href="#词法规则的动作（Lexer-Rule-Actions）" class="headerlink" title="词法规则的动作（Lexer Rule Actions）"></a>词法规则的动作（Lexer Rule Actions）</h1><p>ANTLR词法分析器在匹配词法规则之后创建Token对象。每个对token的请求在Lexer.nextToken中开始，一旦它识别出令牌，它就调用emit函数。emit从词法分析器的当前状态收集的信息为基础以构建token。它访问字段_type，_text，_channel，_tokenStartCharIndex，_tokenStartLine和_tokenStartCharPositionInLine。您可以使用各种setter方法（如setType）设置这些的状态。 例如，如果enumIsKeyword为false，则以下规则将枚举转换为标识符。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ENUM : &apos;enum&apos; &#123;if (!enumIsKeyword) setType(Identifier);&#125; ;</div></pre></td></tr></table></figure>
<p>ANTLR在词法操作中没有特殊的$x属性转换（与v3版本不同）<br>对于词法规则，最多可以有一个单独的动作，而不管该规则中有多少备选方案。</p>
<h1 id="词法命令行（Lexer-Commands）"><a href="#词法命令行（Lexer-Commands）" class="headerlink" title="词法命令行（Lexer Commands）"></a>词法命令行（Lexer Commands）</h1><p>为了避免将语法绑定到特定的目标语言，ANTLR支持词法命令。与任意嵌入操作不同，这些命令遵循特定语法，并且仅限于几个常用命令。Lexer命令显示在词法分析器规则定义的最外部替换的末尾。像任意动作一样，每个token规则只能有一个。 词法命令由 - &gt;运算符组成，后跟一个或多个可以选择参数的命令名：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">TokenName : «alternative» -&gt; command-name</div><div class="line">TokenName : «alternative» -&gt; command-name («identifier or integer»)</div></pre></td></tr></table></figure>
<p>可选的多个命令，以逗号分隔。这里是有效的命令名称：</p>
<ul>
<li>skip</li>
<li>more</li>
<li>popMode</li>
<li>mode( x )</li>
<li>pushMode( x )</li>
<li>type( x )</li>
<li>channel( x )</li>
</ul>
<p>查看图书源代码的用法，一些示例如下所示</p>
<h2 id="skip"><a href="#skip" class="headerlink" title="skip"></a>skip</h2><p>skip命令告诉词法分析器丢弃那些文本。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ID : [a-zA-Z]+ ; // match identifiers</div><div class="line">INT : [0-9]+ ; // match integers</div><div class="line">NEWLINE:&apos;\r&apos;? &apos;\n&apos; ; // return newlines to parser (is end-statement signal)</div><div class="line">WS : [ \t]+ -&gt; skip ; // toss out whitespace</div></pre></td></tr></table></figure>
<h2 id="mode-pushMode-popMode-and-more"><a href="#mode-pushMode-popMode-and-more" class="headerlink" title="mode(), pushMode(), popMode, and more"></a>mode(), pushMode(), popMode, and more</h2><p>模式命令改变模式堆栈，因此改变词法分析器的模式。 more命令强制词法分析器获得另一个标记，但不抛出当前文本。token类型将是匹配“最终”的规则（即，没有更多或跳过命令的那个）的token类型。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">// Default &quot;mode&quot;: Everything OUTSIDE of a tag</div><div class="line">COMMENT : &apos;&lt;!--&apos; .*? &apos;--&gt;&apos; ;</div><div class="line">CDATA   : &apos;&lt;![CDATA[&apos; .*? &apos;]]&gt;&apos; ;OPEN : &apos;&lt;&apos; -&gt; pushMode(INSIDE) ;</div><div class="line"> ...</div><div class="line">XMLDeclOpen : &apos;&lt;?xml&apos; S -&gt; pushMode(INSIDE) ;</div><div class="line">SPECIAL_OPEN: &apos;&lt;?&apos; Name -&gt; more, pushMode(PROC_INSTR) ;</div><div class="line">// ----------------- Everything INSIDE of a tag ---------------------</div><div class="line">mode INSIDE;</div><div class="line">CLOSE        : &apos;&gt;&apos; -&gt; popMode ;</div><div class="line">SPECIAL_CLOSE: &apos;?&gt;&apos; -&gt; popMode ; // close &lt;?xml...?&gt;</div><div class="line">SLASH_CLOSE  : &apos;/&gt;&apos; -&gt; popMode ;</div></pre></td></tr></table></figure>
<p>另外检查：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">lexer grammar Strings;</div><div class="line">LQUOTE : &apos;&quot;&apos; -&gt; more, mode(STR) ;</div><div class="line">WS : [ \r\t\n]+ -&gt; skip ;</div><div class="line">mode STR;</div><div class="line">STRING : &apos;&quot;&apos; -&gt; mode(DEFAULT_MODE) ; // token we want parser to see</div><div class="line">TEXT : . -&gt; more ; // collect more text for string</div></pre></td></tr></table></figure>
<p>弹出模式堆栈的底层将导致异常。使用模式切换命令mode更改当前堆栈顶部。一个或者多个more是相同的和位置并没有关系。</p>
<h2 id="type"><a href="#type" class="headerlink" title="type()"></a>type()</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">lexer grammar SetType;</div><div class="line">tokens &#123; STRING &#125;</div><div class="line">DOUBLE : &apos;&quot;&apos; .*? &apos;&quot;&apos;   -&gt; type(STRING) ;</div><div class="line">SINGLE : &apos;\&apos;&apos; .*? &apos;\&apos;&apos; -&gt; type(STRING) ;</div><div class="line">WS     : [ \r\t\n]+    -&gt; skip ;</div></pre></td></tr></table></figure>
<p>对于多个type()命令，只有最右边的命令有效果。</p>
<h2 id="channel"><a href="#channel" class="headerlink" title="channel()"></a>channel()</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">BLOCK_COMMENT</div><div class="line">    : &apos;/*&apos; .*? &apos;*/&apos; -&gt; channel(HIDDEN)</div><div class="line">    ;</div><div class="line">LINE_COMMENT</div><div class="line">    : &apos;//&apos; ~[\r\n]* -&gt; channel(HIDDEN)</div><div class="line">    ;</div><div class="line">... </div><div class="line">// ----------</div><div class="line">// Whitespace</div><div class="line">//</div><div class="line">// Characters and character constructs that are of no import</div><div class="line">// to the parser and are used to make the grammar easier to read</div><div class="line">// for humans.</div><div class="line">//</div><div class="line">WS : [ \t\r\n\f]+ -&gt; channel(HIDDEN) ;</div></pre></td></tr></table></figure>
<p>从4.5开始，您还可以在词法分析器规则上方使用以下结构来定义频道名称（如枚举）：</p>
<p><code>channels { WSCHANNEL, MYHIDDEN }</code></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://geekcat.me/2017/01/02/2017/构造自定义领域语言（一）/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="geekcat">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/user.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="GeekCat">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="GeekCat" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/02/2017/构造自定义领域语言（一）/" itemprop="url">
                  构造自定义领域语言（一）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-02T11:18:46+08:00">
                2017-01-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/01/02/2017/构造自定义领域语言（一）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/01/02/2017/构造自定义领域语言（一）/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近的工作一直在开发公司内部的数据查询平台，随着查询引擎的增加，后台的复杂度徒增。使用单纯的SQL拼接来生成不同的SQL方言已经很难维护。个人主张设计一套自定义的领域语言，用作界面查询的表达，后台统一翻译成IR(Intermediate language)，再通过不同的翻译器生成不同平台的SQL语言。</p>
<p>例如神策系统中这段中文在后台需要转化成不同查询引擎的SQL。<br><img src="/images/神策.png"><br>但是大型系统就像马拉的战车，系统越大，马越多就越难拐弯。所以个人想先使用业余时间做一番实践，观察结果，再考虑生成环境的转型。</p>
<h1 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h1><p>工欲善其事必先利其器，综合考虑使用ANTLR工具来进行实践（Hive SQL的解析就是使用的ANTLR工具，ANTLR可以通过简洁的语法生成解析树、AST）。</p>
<p>ANTLR ANTLR官网<br>GQL 准备通过这个项目来同步学习实践的代码。<br>编程语言实现模式、The Definitive ANTLR 4 Reference 学习书籍</p>
<h1 id="解析起步"><a href="#解析起步" class="headerlink" title="解析起步"></a>解析起步</h1><p>ANTLR使用递归下降的方式解析语言，《编程语言实现模式》中前四种模式：</p>
<p>模式一：从文法到递归下降识别器（无法解决左递归文法，每层递归都无法消解任何词语），文法中每一个规则对应一个Parser类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">G</span> <span class="keyword">extends</span> <span class="title">Parser</span> </span>&#123;</div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 词法单元类型的定义</div><div class="line">	 * 合适的构造函数</div><div class="line">	 * 规则对应的方法</div><div class="line">	 */</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>模式二：LL(1)递归下降的词法解析器，每次向前看一个字符，一次token一个词法单元。<br>模式三：LL(1)递归下降的语法解析器，每次向前看一个词法单元，通过语法规则前缀判断如何应用规则（对于多个规则有公共左子式，向前读一个词法单元就无能为力了）。<br>模式四：LL(K)递归下降的语法解析器，相比模式三，向前读的词法单元变成了K个。只要K大于公共左子式的长度，就可以解析下去。</p>
<p>解析实践</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">grammar GQL;</div><div class="line">gql_behavior  : &apos;按&apos; cycle statistics;</div><div class="line">cycle : &apos;每天&apos;</div><div class="line">      | &apos;每月&apos;</div><div class="line">      | &apos;每小时&apos;</div><div class="line">      | &apos;每分钟&apos;</div><div class="line">      ;</div><div class="line">statistics : &apos;统计&apos; index groups;</div><div class="line">index : table &apos;的&apos; columns;</div><div class="line">table : (~(&apos;的&apos;))+;</div><div class="line">columns : column (&apos;和&apos; columns)*;</div><div class="line">column : ~(&apos;的&apos;|&apos;和&apos;|&apos;按&apos;)+;</div><div class="line">groups : group+;</div><div class="line">group : &apos;按&apos; groupItem &apos;查看&apos;;</div><div class="line">groupItem : ANY_CHAR+;</div><div class="line">ANY_CHAR : .;</div><div class="line">WS : [ \t\r\n]+ -&gt; skip ;</div></pre></td></tr></table></figure>
<p>匹配“按每天统计用户表的触发用户数和触发用户总次数按渠道查看按时间查看”</p>
<img src="/images/解析树.png">
<p>下星期继续更新实践</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://geekcat.me/2016/12/29/2016 Year in Review/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="geekcat">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/user.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="GeekCat">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="GeekCat" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/29/2016 Year in Review/" itemprop="url">
                  Merry Christmas！
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-29T00:31:16+08:00">
                2016-12-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/review/" itemprop="url" rel="index">
                    <span itemprop="name">review</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/29/2016 Year in Review/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/29/2016 Year in Review/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>2016年，从学校走向社会，生活节奏自由而明快。告别实验室到寝室的两点一线，拥抱大广州的温暖明媚。</p>
<h1 id="一、二月"><a href="#一、二月" class="headerlink" title="一、二月"></a>一、二月</h1><p>苦逼的论文季。15年找到工作后便拖延症附体，只得寒假里闭关，记得把自己关在家里足足有一个月，整日与office相依为命，孤苦愤懑，好歹是把初稿给挤了出来（六月份又被一通魔改那就是后话了），精神消瘦，肉体膨胀。</p>
<p><a href="https://book.douban.com/subject/5333562/" target="_blank" rel="external">《深入理解计算机系统》</a> 这是这两个月看的唯一一本技术书，简直圣经级教材，全面的的讲解了计算机整体的运行机理，完全弥补了我本科组成原理、操作系统神游四方的知识空洞。我就纳闷当年怎么不用此书开课，非得啃国内老教授晦涩难懂，一直纠结硬件层，让人晕头转向的大作。</p>
<h1 id="三、四、五月"><a href="#三、四、五月" class="headerlink" title="三、四、五月"></a>三、四、五月</h1><p>新鲜的实习季。初来数据运营组实习，我的工作任务主要是接手一个PHP的Web工程，还好PHP是世界上最好的语言，花了一个星期的时间从入门到放弃上手。但最最痛苦的是写Hive SQL，1.3版本的Hive慢到乌龟爬，Bug到处有，对于急性子简直是天生的折磨（还好我战胜了它 o(╬￣皿￣)=○# (￣#)3￣)）。这段时间里最大的收获倒不是学习了新的语言，新的查询工具，而是认识到数据组整体的工作本质。一开始使用上报SDK进行数据埋点，消息队列、Hadoop对再对数据进行收集清洗，定时调度生成多维度的数据报表提供给数据分析人员，帮助运营人员决策。</p>
<p><a href="https://book.douban.com/subject/6559267/" target="_blank" rel="external">《深入PHP面向对象、模式与实践》</a>、<a href="https://book.douban.com/subject/26635862/" target="_blank" rel="external">《Modern PHP》</a> PHP入门我看的是这两本书，如果对面向对象、设计模式比较熟悉，看完语法层第一本书就可以跳着过一遍了，第二本则侧重实践风格、工具使用、测试规范等等。<br><a href="https://book.douban.com/subject/25791255/" target="_blank" rel="external">《Hive编程指南》</a> 一本工具书，不懂就翻，相对来说Hive资料网上相对较少，这是一个很好的补充。</p>
<h1 id="六月"><a href="#六月" class="headerlink" title="六月"></a>六月</h1><p>烦闷的答辩季。一心想成为小透明的我，还是应验了墨菲定律，论文抽中万五。经历一个星期惨无人道的论文魔改。git管理的论文目录从20M飙升到50M，一句话就是：你不知道我经历了神马。</p>
<h1 id="七、八、九月"><a href="#七、八、九月" class="headerlink" title="七、八、九月"></a>七、八、九月</h1><p>疯狂的试用期。试用期的工作强度与实习期就完全是天壤之别，完不成工作进度的我，就经常周末加班了 ┐(—__—)┌。(头发没了，我也变强了——《一拳超人》)</p>
<p><a href="https://es.xiaoleilu.com/" target="_blank" rel="external">《Elasticsearch 权威指南》</a> 这本电子书帮助我完成了第一个体量比较大的功能，搜索整个公司用户的基本信息。<br><a href="https://book.douban.com/subject/6523762/" target="_blank" rel="external">《Hadoop权威指南》</a>、<a href="https://book.douban.com/subject/10748460/" target="_blank" rel="external">《Hbase权威指南》</a> 为了了解学习使用国内开源Kylin分布式分析引擎（底层使用Hbase进行存储），好对组里实现的魔改版Spark作竞品对比。<br><a href="https://book.douban.com/subject/26745943/" target="_blank" rel="external">《css揭秘》</a> 作为有名组里的胶水人物，当然是不只懂得数据相关的知识哇，不过css入门我是不建议看这本书的。</p>
<h1 id="十、十一、十二月"><a href="#十、十一、十二月" class="headerlink" title="十、十一、十二月"></a>十、十一、十二月</h1><p>转正后的猿人生活。我相信选择成为猿的同志们，生命中总有那么几个契机，引导了你。对我而言，第一道转折是小学时期接触的一款游戏：《重装机兵》(1991由日本游戏公司Crea-Tech出品)，主人公和志同道合的朋友踏上充满危险的冒险之旅，开着男人的浪漫（坦克）拯救世界。然而给我种下这颗种子的并不是主人公，而是最终Boss若亚，身为分布式电脑集群的它，被制造的初衷是为了保护环境。然而病毒感染，程序错乱，导致计算出错，得出了保护地球环境就必须完全消灭人类的结论。好奇心就是这么神奇，为我打开了第一道大门。而这份职业也就是如此神奇能让你保持饥饿，保持愚蠢，哈哈美妙的生活。</p>
<p><a href="https://book.douban.com/subject/10484692/" target="_blank" rel="external">《Java并发编程实战》</a> 为开发组内的调度系统，打下基础。<br><a href="https://book.douban.com/subject/1052241/" target="_blank" rel="external">《设计模式》</a> 又是一本圣经读物。<br><a href="https://book.douban.com/subject/10546125/" target="_blank" rel="external">《JavaScript高级程序设计》</a> 自己业余开始全面的学习前端知识。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://geekcat.me/2016/12/25/Merry Christmas！/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="geekcat">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/user.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="GeekCat">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="GeekCat" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/25/Merry Christmas！/" itemprop="url">
                  Merry Christmas！
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-25T07:25:33+08:00">
                2016-12-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/广州/" itemprop="url" rel="index">
                    <span itemprop="name">广州</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/25/Merry Christmas！/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/25/Merry Christmas！/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>圣诞节哇，像舶来的美食，又在国内师傅的改良下呈现的糕点，又甜又红，一嘴下去，有些迷醉，我眼里竟是被特赦的囚犯，年底热情洋溢的上街放风。</p>
<p>小时候，我总喜欢，花大笔的银子，来买那些我眼里最古怪，最奇特的会变形的贺卡。送给玩伴和给我抄作业的姑娘。然后等待过年，等待压岁钱填补国库的亏空。</p>
<p>初中高中，家里穷到总算没钱可以给我乱花，圣诞节多半是坐在大会堂里，看表演，看窗外的雪，听各班班草班花们唱类似Jingle Bells的歌曲。</p>
<p>每年都可以是一个好圣诞哇，因为这不是传统节日，你可以开心快乐，你可以悲伤抽风。你可以回忆和朋友一起看的《小鬼当家》。你也可以独自一人以一种独特的方式review一下今年的喜怒哀乐。</p>
<p>今年我长了一对犄角，我有了大目标，也有了小心思。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://geekcat.me/2016/12/10/Gworm/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="geekcat">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/user.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="GeekCat">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="GeekCat" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/10/Gworm/" itemprop="url">
                  Gworm
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-10T17:40:33+08:00">
                2016-12-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/开发/" itemprop="url" rel="index">
                    <span itemprop="name">开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/10/Gworm/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/10/Gworm/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Gworm"><a href="#Gworm" class="headerlink" title="Gworm"></a>Gworm</h1><p>Gworm是一个java版的爬虫框架，以json格式作为返回。</p>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="#依赖包">依赖包</a></li>
<li><a href="#参数文件">参数文件</a><ul>
<li><a href="#爬取规则">爬取规则</a></li>
<li><a href="#请求参数">请求参数</a></li>
</ul>
</li>
<li><a href="#示例程序">示例程序</a><ul>
<li><a href="#初始化">初始化</a></li>
<li><a href="#链接生成器">链接生成器</a></li>
<li><a href="#数据操作">数据操作</a></li>
<li><a href="#异步加载">异步加载</a></li>
</ul>
</li>
</ul>
<h2 id="依赖包"><a href="#依赖包" class="headerlink" title="依赖包"></a>依赖包</h2><ul>
<li>JSON库 : Gson 2.6.2</li>
<li>DOM提取 : jsoup 18.3</li>
<li>WebDriver : selenium-java 2.53.0</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">#pom.xml</div><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></div><div class="line">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.gyak.gworm<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>gworm<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.code.gson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>gson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jsoup<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jsoup<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.seleniumhq.selenium<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>selenium-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.53.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">source</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">target</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure>
<h2 id="参数文件"><a href="#参数文件" class="headerlink" title="参数文件"></a>参数文件</h2><p>使用Gworm爬虫框架需要配置两份文件，爬虫规则文件、请求参数文件。</p>
<h3 id="爬取规则"><a href="#爬取规则" class="headerlink" title="爬取规则"></a>爬取规则</h3><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">//src\test\resources\jd.json</div><div class="line">[</div><div class="line">  &#123;</div><div class="line">    "id": "Book",</div><div class="line">    "gwormArray": &#123;</div><div class="line">      "id": "bookList",</div><div class="line">      "rule": "#plist .gl-item",</div><div class="line">      "list": [</div><div class="line">        &#123;</div><div class="line">          "id": "bookName",</div><div class="line">          "rule": ".p-name",</div><div class="line">          "get": "text"</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          "id": "bookPage",</div><div class="line">          "rule": ".p-name a",</div><div class="line">          "get": "href"</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          "id": "bookAuthor",</div><div class="line">          "rule": ".author_type_1 a",</div><div class="line">          "get": "text"</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">]</div></pre></td></tr></table></figure>
<h3 id="请求参数"><a href="#请求参数" class="headerlink" title="请求参数"></a>请求参数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Accept=text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</div><div class="line">Accept-Encoding=gzip, deflate, sdch</div><div class="line">Accept-Language=zh-CN,zh;q=0.8</div><div class="line">Connection=keep-alive</div><div class="line">User-Agent=Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/40.0.2214.94 Safari/537.36</div></pre></td></tr></table></figure>
<h2 id="示例程序"><a href="#示例程序" class="headerlink" title="示例程序"></a>示例程序</h2><p>通过几段示例程序使用Gworm爬取京东20页的图书信息</p>
<h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><p><code>GwormBox</code>顾名思义为爬虫箱子，使用单例模式初始化，保存所有的爬虫规则。<code>RequestProperties</code>为整个爬虫框架配置请求参数，<code>addGworm</code>方法添加一套爬取规则。<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">//src\test\java\com\gyak\test\Test.java</div><div class="line">GwormBox gwormBox = GwormBox.getInstance();</div><div class="line">RequestProperties rp = RequestProperties.getInstance();</div><div class="line">//REQUEST_FILE 请求参数文件名</div><div class="line">rp.initProperties(ClassLoader.getSystemResourceAsStream(REQUEST_FILE));</div><div class="line">//WORM_CONFIG 爬取配置文件名</div><div class="line">//NAME 对配置设置的别名</div><div class="line">gwormBox.addGworm(WORM_CONFIG, NAME);</div><div class="line">```        </div><div class="line"></div><div class="line">### 链接生成器</div><div class="line"></div><div class="line">url生成器用来生产爬取目标，方便串行、并行的爬取目标，接口为`UrlGeneration`</div><div class="line">```java</div><div class="line">//src\test\java\com\gyak\test\Test.java</div><div class="line">class JdUrlGeneration implements UrlGeneration &#123;</div><div class="line"></div><div class="line">    private int currentPage = 1;</div><div class="line">    private final String page = "http://list.jd.com/list.html?cat=1713,3258,3297&amp;page=%d&amp;trans=1&amp;JL=6_0_0";</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public int getStart() &#123;</div><div class="line">        return 1;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public int getEnd() &#123;</div><div class="line">        return 20;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void next() &#123;</div><div class="line">        currentPage ++;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public HasUrl getCurrentbindObj() &#123;</div><div class="line">        return new HasUrl() &#123;</div><div class="line">            private String url = String.format(page, currentPage);</div><div class="line">            @Override</div><div class="line">            public String getUrl() &#123;</div><div class="line">                return url;</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="数据操作"><a href="#数据操作" class="headerlink" title="数据操作"></a>数据操作</h3><p><code>GwormCoordinate</code>规则定位器，传入<code>GwormAction</code>中用来指定使用的规则，实现虚函数<code>action</code>用来处理已经爬回的json数据，<code>bindObj</code>对应URL生成器绑定的对象。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//src\test\java\com\gyak\test\Test.java</span></div><div class="line">UrlGeneration jd = <span class="keyword">new</span> JdUrlGeneration();</div><div class="line"><span class="comment">//NAME 爬虫规则的别名</span></div><div class="line"><span class="comment">//URL_ID 规则中指定链接</span></div><div class="line">GwormCoordinate coordinate = <span class="keyword">new</span> GwormCoordinate(NAME, URL_ID); </div><div class="line"><span class="comment">//concurrency 并发数</span></div><div class="line">GwormAction ga = <span class="keyword">new</span> GwormAction(concurrency, jd, coordinate) &#123;</div><div class="line">	<span class="comment">/**</span></div><div class="line">     * 爬取结果的处理函数</div><div class="line">     * <span class="doctag">@param</span> json 爬取的JSON</div><div class="line">     * <span class="doctag">@param</span> bind 对应url生成器绑定的对象</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">action</span><span class="params">(String json, Object bindObj)</span> </span>&#123;</div><div class="line">        JsonArray jsonArray = json.get(BOOK_LIST).getAsJsonArray();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;jsonArray.size();i++) &#123;</div><div class="line">            JsonObject obj = jsonArray.get(i).getAsJsonObject();</div><div class="line">            String bookName = obj.get(BOOK_NAME).getAsString();</div><div class="line">            String bookPage = obj.get(BOOK_PAGE).getAsString();</div><div class="line">            String bookAuthor = obj.get(BOOK_AUTHOR).getAsString();</div><div class="line">            String bookComment = obj.get(BOOK_COMMENT).getAsString();</div><div class="line">            System.out.println(<span class="string">"书名："</span> + bookName);</div><div class="line">            System.out.println(<span class="string">"购买链接："</span> + bookPage);</div><div class="line">            System.out.println(<span class="string">"作者："</span> + bookAuthor);</div><div class="line">            System.out.println(<span class="string">"￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;;</div><div class="line"></div><div class="line">ga.work(); <span class="comment">//启动爬取</span></div></pre></td></tr></table></figure></p>
<h3 id="异步加载"><a href="#异步加载" class="headerlink" title="异步加载"></a>异步加载</h3><p>对于有些通过异步来加载数据的网页，提取这部分数据必须运行js后方能获得，对于这些网页可以自行实现<a href="/src/main/java/com/gyak/http/Htmlable.java">Htmlable</a>（例如调用Chrome来获取html）接口。</p>
<p>最新添加了ChromeProxy类，实现了调用Chrome来爬取异步加载页面，具体示例详见<a href="/src/test/java/com/gyak/test/ChromeProxyTest.java">ChromeProxy</a><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ChromeProxy chromeProxy = <span class="keyword">new</span> ChromeProxy(<span class="string">"C:\\Users\\guiya\\Desktop\\chromedriver.exe"</span>);</div></pre></td></tr></table></figure></p>
<p><a href="https://sites.google.com/a/chromium.org/chromedriver/" target="_blank" rel="external">ChromeDriver下载地址</a></p>
<p><a href="http://www.seleniumhq.org/download/" target="_blank" rel="external">其他WebDriver下载地址</a></p>
<p>运行测试代码时，请修改为自己WebDriver放置的路径。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://geekcat.me/2016/12/10/一团乱麻/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="geekcat">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/user.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="GeekCat">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="GeekCat" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/10/一团乱麻/" itemprop="url">
                  一团乱麻
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-10T17:40:33+08:00">
                2016-12-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/广州/" itemprop="url" rel="index">
                    <span itemprop="name">广州</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/10/一团乱麻/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/10/一团乱麻/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="饿货"><a href="#饿货" class="headerlink" title="饿货"></a>饿货</h2><p>很早之前我就确认过一个事实，我不是一个吃货，而是一个彻彻底底的饿货，所谓饿货吃是没有多少讲究的，唯独食量可以和吃货一比，吃货则不同，精挑细选，为了食物可以走南闯北。<br>来到广州的饿货我丝毫没有吃货前来的朝圣感，每日亵渎食物也沾沾自喜，既不会有神灵的惩罚，也不会在乎公司的餐补。直到我点了一份鱼丸。</p>
<h2 id="鱼丸"><a href="#鱼丸" class="headerlink" title="鱼丸"></a>鱼丸</h2><p>林是我的同事，是一个发型极好的小青年，每每映入我眼帘的永远是他的发型。颜值当然不可能是我们的共同点，但我们一个思想江化，一个江信江疑。无论是代码搭档起来还是使用膜法，乃是绝配。<br>鱼丸事件结束后，他告诉我，广州食物是有“毒”的，所谓毒是需要被中和的，否则一定会从身体的薄弱处爆发出来，不用害怕，这解药遍布于广州大街小巷。</p>
<h2 id="凉茶"><a href="#凉茶" class="headerlink" title="凉茶"></a>凉茶</h2><p>寻到一家凉茶铺子，并没有林说的那么简单，但为了解毒，这些功夫也不算什么。<br>这救命的凉茶摆在我面前与王老吉有几分相似，难道也是红糖味儿嘛，定要一饮而尽。</p>
<h2 id="红色石头"><a href="#红色石头" class="headerlink" title="红色石头"></a>红色石头</h2><p>味道让人永生难忘，像用红砖头磨出的分泡制而成，嗓子被这石头堵住，七魂六魄被苦的颠三倒四。然而我的肠胃并没有好，身体更加虚落，精神涣散。</p>
<h2 id="粥"><a href="#粥" class="headerlink" title="粥"></a>粥</h2><p>在广州万事是离不开吃的，虚落对应的当然是食补。<br>斌是我的前辈，也是我们的司机，无论是开发还是生活遇到麻烦，他就会化身为铜锣湾的浩南，尽显一个扛把子的本色。<br>浩南永远是浩南，变身只差一个契机，而那一天，他准备带我们去长洲收收钱，哦不，尝尝粥。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/user.png"
               alt="geekcat" />
          <p class="site-author-name" itemprop="name">geekcat</p>
          <p class="site-description motion-element" itemprop="description">参差多态是幸福的本源</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">12</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">15</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">geekcat</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"guiyanakuang"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  








  
  

  

  

  

  


</body>
</html>
